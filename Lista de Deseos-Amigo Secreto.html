<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amigo Secreto üéÅ - Firebase</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background: linear-gradient(to bottom, #001f3f, #003366);
    color: #fff;
    min-height: 100vh;
    text-align: center;
    overflow-x: hidden;
  }

  h1 { font-family: 'Great Vibes', cursive; font-size: 4em; color: #ffd700; text-shadow: 2px 2px 10px #ff0000; margin: 20px 0; }
  h2 { color: #ff6961; margin-top: 30px; }

  .section {
    background: rgba(0,0,0,0.5);
    margin: 20px auto;
    padding: 20px;
    border-radius: 20px;
    max-width: 500px;
    box-shadow: 0 0 20px #ff0000, 0 0 30px #00ff00 inset;
  }

  input, select, button {
    padding: 10px; margin: 5px; font-size: 16px; border-radius: 10px; border: 2px solid #ffd700; outline: none;
  }
  button { background: #ff6961; color: #fff; font-weight: bold; cursor: pointer; transition: transform 0.2s, background 0.3s; }
  button:hover { background: #ff0000; transform: scale(1.1); }

  ul { list-style: none; padding: 0; margin-top: 10px; }
  .gift { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.2); border-radius: 15px; padding: 10px 15px; margin: 8px auto; width: 90%; transition: transform 0.3s, background 0.3s; cursor: pointer; }
  .gift:hover { transform: scale(1.05); background: rgba(255, 255, 255, 0.4); }
  .taken { text-decoration: line-through; color: #aaa; background: rgba(0,0,0,0.3); }

  /* Confeti */
  .confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background-color: #ff0;
    top: 0;
    animation: fall 3s linear forwards;
    z-index: 9999;
    border-radius: 50%;
    pointer-events: none;
  }

  @keyframes fall {
    to {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }

  /* Nieve elegante */
  .snowflake {
    position: fixed;
    top: -50px;
    color: #fff;
    font-size: 1em;
    user-select: none;
    pointer-events: none;
    animation-name: snow;
    animation-iteration-count: infinite;
    animation-timing-function: linear;
  }

  @keyframes snow {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
  }
</style>
</head>
<body>

<h1>üéÑ Amigo Secreto üéÅ</h1>

<div class="section" id="groupSection">
  <h2>1. Crea o √∫nete a un grupo</h2>
  <input type="text" id="groupCode" placeholder="C√≥digo de grupo (4 letras)">
  <input type="text" id="username" placeholder="Tu nombre">
  <button onclick="joinGroup()">Entrar</button>
  <p style="color:#ffd700; font-size:14px;">Comparte el c√≥digo con tu familia para que todos se unan.</p>
</div>

<div class="section" id="wishlistSection" style="display:none;">
  <h2>2. Tu lista de deseos</h2>
  <input type="text" id="giftInput" placeholder="Nombre del regalo">
  <button onclick="addGift()">Agregar</button>
  <ul id="myWishlist"></ul>
</div>

<div class="section" id="selectSection" style="display:none;">
  <h2>3. Selecciona regalos de otros</h2>
  <select id="otherUserList" onchange="loadOtherWishlist()">
    <option value="">Selecciona un participante</option>
  </select>
  <ul id="otherWishlist"></ul>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// üîπ Configuraci√≥n de Firebase (tu snippet)
const firebaseConfig = {
  apiKey: "AIzaSyDrnFIm58PIEHfIw8UeadL-Mfe4753u9R8",
  authDomain: "amigo-secreto-lista-de-deseos.firebaseapp.com",
  projectId: "amigo-secreto-lista-de-deseos",
  storageBucket: "amigo-secreto-lista-de-deseos.firebasestorage.app",
  messagingSenderId: "241755952106",
  appId: "1:241755952106:web:a15f9a5db3e05f81381893",
  measurementId: "G-FY31FG62T6"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let username = "";
let groupCode = "";

// Entrar a un grupo
function joinGroup() {
  username = document.getElementById('username').value.trim();
  groupCode = document.getElementById('groupCode').value.trim().toUpperCase();
  if(!username || !groupCode) return alert("Ingresa tu nombre y c√≥digo");

  document.getElementById('groupSection').style.display = 'none';
  document.getElementById('wishlistSection').style.display = 'block';
  document.getElementById('selectSection').style.display = 'block';

  loadMyWishlist();
  listenGroup();
}

// Agregar regalo
function addGift() {
  const giftName = document.getElementById('giftInput').value.trim();
  if(!giftName) return;
  const giftRef = db.collection('groups').doc(groupCode).collection('users').doc(username);
  giftRef.set({
    gifts: firebase.firestore.FieldValue.arrayUnion({name: giftName, taken:false})
  }, {merge:true});
  document.getElementById('giftInput').value='';
}

// Escuchar cambios del grupo
function listenGroup() {
  db.collection('groups').doc(groupCode).collection('users')
    .onSnapshot(snapshot => {
      const data = {};
      snapshot.forEach(doc => data[doc.id] = doc.data().gifts || []);
      updateUI(data);
    });
}

// Actualizar la UI
function updateUI(data) {
  // Mi lista
  const myList = document.getElementById('myWishlist');
  myList.innerHTML = '';
  if(data[username]){
    data[username].forEach(g => {
      const li = document.createElement('li');
      li.textContent = g.name;
      li.className = g.taken ? 'taken gift' : 'gift';
      myList.appendChild(li);
    });
  }

  // Otros participantes
  const select = document.getElementById('otherUserList');
  select.innerHTML = '<option value="">Selecciona un participante</option>';
  Object.keys(data).forEach(user => {
    if(user!==username){
      const option = document.createElement('option');
      option.value = user;
      option.textContent = user;
      select.appendChild(option);
    }
  });
  loadOtherWishlist();
}

// Cargar lista de otros
function loadOtherWishlist(){
  const otherUser = document.getElementById('otherUserList').value;
  const ul = document.getElementById('otherWishlist');
  ul.innerHTML = '';
  if(!otherUser) return;
  db.collection('groups').doc(groupCode).collection('users').doc(otherUser).get().then(doc=>{
    const gifts = doc.data()?.gifts || [];
    gifts.forEach((g,index)=>{
      const li = document.createElement('li');
      li.textContent = g.name;
      li.className = g.taken ? 'taken gift' : 'gift';
      if(!g.taken){
        const btn = document.createElement('button');
        btn.textContent = "Seleccionar";
        btn.onclick = ()=> selectGift(otherUser,index);
        li.appendChild(btn);
      }
      ul.appendChild(li);
    });
  });
}

// Seleccionar regalo
function selectGift(user,index){
  const userRef = db.collection('groups').doc(groupCode).collection('users').doc(user);
  userRef.get().then(doc=>{
    const gifts = doc.data()?.gifts || [];
    if(gifts[index].taken) return; // ya tomado
    gifts[index].taken = true;
    userRef.set({gifts}, {merge:true});
    createConfetti();
  });
}

// Confeti
function createConfetti() {
  for (let i=0; i<30; i++) {
    const conf = document.createElement('div');
    conf.className = 'confetti';
    conf.style.left = Math.random() * window.innerWidth + 'px';
    conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
    conf.style.width = conf.style.height = Math.random() * 8 + 4 + 'px';
    document.body.appendChild(conf);
    setTimeout(() => conf.remove(), 3000);
  }
}

// Nieve elegante
for(let i=0;i<50;i++){
  const snow = document.createElement('div');
  snow.className='snowflake';
  snow.style.left=Math.random()*100+'%';
  snow.style.fontSize=Math.random()*24+12+'px';
  snow.style.animationDuration=3+Math.random()*5+'s';
  snow.style.opacity=Math.random();
  snow.textContent='‚ùÑ';
  document.body.appendChild(snow);
}
</script>

</body>
</html>
